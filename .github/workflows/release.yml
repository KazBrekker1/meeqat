name: release

on:
  push:
    branches:
      - main
      - dev
jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest # Arm based macs
            args: --target aarch64-apple-darwin
          - platform: macos-latest # Intel based macs
            args: --target x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ""
          - platform: windows-latest
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        # webkitgtk 4.0 is for Tauri v1 - webkitgtk 4.1 is for Tauri v2.

      - name: Install frontend dependencies
        run: bun install

      - name: Build frontend
        run: bun generate

      - name: Verify frontend build
        run: |
          echo "=== Checking dist folder ==="
          ls -la dist/ || echo "No dist folder!"
          ls -la dist/_nuxt/ 2>/dev/null | head -10 || echo "No _nuxt folder!"
          echo "=== Dist folder size ==="
          du -sh dist/ || echo "Failed to get dist size"

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: meeqat-v__VERSION__
          releaseName: Meeqat v__VERSION__
          releaseBody: After installing the Apple app you have to run "xattr -c /Applications/Meeqat.app" once before launching
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

      - name: List build artifacts
        run: |
          echo "=== Build artifacts ==="
          find src-tauri/target -name "*.dmg" -o -name "*.app" -o -name "*.exe" -o -name "*.msi" -o -name "*.deb" -o -name "*.AppImage" 2>/dev/null | head -20
          echo "=== Artifact sizes ==="
          find src-tauri/target -name "*.dmg" -exec ls -lh {} \; 2>/dev/null || true
          find src-tauri/target -name "*.exe" -exec ls -lh {} \; 2>/dev/null || true
          find src-tauri/target -name "*.msi" -exec ls -lh {} \; 2>/dev/null || true
          find src-tauri/target -name "*.deb" -exec ls -lh {} \; 2>/dev/null || true
          find src-tauri/target -name "*.AppImage" -exec ls -lh {} \; 2>/dev/null || true

  publish-android-apk:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    environment: Main
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platforms;android-34" \
            "build-tools;29.0.3" \
            "build-tools;34.0.0" \
            "platform-tools" \
            "ndk;26.1.10909125" \
            "cmake;3.22.1"

      - name: Export Android NDK environment variables
        run: |
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

      - name: Install frontend dependencies
        run: bun install

      - name: Initialize Android project (if missing)
        run: test -d src-tauri/gen/android || bun run tauri:android:init

      - name: Build Android APK (release)
        run: bun run tauri android build

      - name: List build outputs
        run: |
          echo "=== APK files ==="
          find src-tauri/gen/android -name "*.apk" -exec ls -lh {} \;
          echo "=== AAB files ==="
          find src-tauri/gen/android -name "*.aab" -exec ls -lh {} \;

      - name: Compute version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Validate Android signing secrets
        run: |
          if [ -z "${{ secrets.ANDROID_SIGNING_KEY_STORE_BASE64 }}" ]; then echo "Missing secret ANDROID_SIGNING_KEY_STORE_BASE64"; exit 1; fi
          if [ -z "${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}" ]; then echo "Missing secret ANDROID_SIGNING_KEY_ALIAS"; exit 1; fi
          if [ -z "${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}" ]; then echo "Missing secret ANDROID_SIGNING_STORE_PASSWORD"; exit 1; fi
          if [ -z "${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}" ]; then echo "Missing secret ANDROID_SIGNING_KEY_PASSWORD"; exit 1; fi

      - name: Sanity-check keystore decoding
        env:
          ANDROID_SIGNING_KEY_STORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEY_STORE_BASE64 }}
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
        run: |
          echo "$ANDROID_SIGNING_KEY_STORE_BASE64" | base64 -d > keystore.jks
          keytool -list -keystore keystore.jks -storepass "$ANDROID_SIGNING_STORE_PASSWORD" >/dev/null

      - name: Sign Android APKs
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: src-tauri/gen/android/app/build/outputs/apk/universal/release
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY_STORE_BASE64 }}
          alias: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}

      - name: Sign Android AABs
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: src-tauri/gen/android/app/build/outputs/bundle/universalRelease
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY_STORE_BASE64 }}
          alias: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}

      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: meeqat-v${{ env.VERSION }}
          files: |
            src-tauri/gen/android/**/outputs/**/*.apk
            src-tauri/gen/android/**/outputs/**/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
